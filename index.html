<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">

    <!-- 核心适配：禁止缩放，适配刘海屏，强制竖屏友好 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>塔罗牌预测系统</title>

    <!-- PWA / 移动端优化标签 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#050505">

    <!-- logo -->
    <link rel="icon" href="assets/logo2.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/logo2.png">

    <!-- 引入自定义样式 (模块化) -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/loading.css">
    <link rel="stylesheet" href="styles/guide.css">
    <link rel="stylesheet" href="styles/modals.css">
    <link rel="stylesheet" href="styles/results.css">

    <!-- 引入外部库 (Three.js, MediaPipe, Marked) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <!-- Loading 界面 -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; color:#666;">初始化命运系统...</p>
        <button id="start-btn">点击开启仪式</button>
    </div>

    <!-- 摄像头视频流 (隐藏，用于分析) -->
    <!-- playsinline 是微信/iOS 禁止自动全屏播放视频的关键 -->
    <video id="input_video" playsinline webkit-playsinline></video>

    <!-- 3D 渲染容器 -->
    <div id="canvas-container"></div>

    <!-- UI 交互层 -->
    <div id="ui-layer">

        <!-- 顶部按钮组 (帮助 & 设置) -->
        <div class="top-controls">
            <button id="settings-btn" title="系统设置">⚙️</button>
            <button id="help-btn" title="操作指南">?</button>
        </div>

        <div class="status-bar">
            <h1>ARCANA GESTURA</h1>
            <div class="sub-text">手势驱动 · 塔罗预测系统</div>
        </div>

        <!-- 核心引导区 -->
        <div id="guide-overlay">
            <div id="guide-content" class="instruction">
                <span class="gesture-icon">👋</span>
                <h2>举起你的右手</h2>
                <p>让摄像头看见你的手掌以开始</p>
            </div>
            <!-- 选牌进度条 -->
            <div id="progress-container"><div id="progress-bar"></div></div>
        </div>

        <!-- 解牌结果面板 -->
        <div id="result-panel">
            <div id="result-content">
                <h2 style="color:var(--primary); text-align:center; margin-bottom:30px;">命运指引</h2>
                <div class="card-reveal" id="card-reveal-container"></div>
                <div id="ai-text">正在连接宇宙意识</div>
                <div style="text-align:center; margin-top:30px; font-size:12px; color:#555;">
                    握拳 🤛 保持 1.5 秒 可重置仪式
                </div>
            </div>
        </div>

        <!-- 设置模态框 -->
        <div id="settings-modal" class="modal-backdrop">
            <div class="modal-content">
                <span id="close-settings" class="close-modal">&times;</span>
                <h2>系统设置</h2>

                <div class="setting-item">
                    <label for="api-key-input">AI 模型密钥 (Aliyun Qwen)</label>
                    <p class="setting-desc">输入 Key 以启用深度解牌功能，留空则使用模拟数据。</p>
                    <input type="password" id="api-key-input" placeholder="sk-affb2f48526b4aa38cadfd3004646fcc">
                </div>

                <div class="setting-item">
                    <label>关于我</label>
                    <p class="setting-desc">
                      Arcana Gestura <span id="version">v1.x.x</span> - 基于 WebGazer 与 Three.js 构建。
                      &copy; rainbow_yu
                    </p>

                </div>
            </div>
        </div>

        <!-- 帮助模态框 (新手引导) -->
        <div id="help-modal" class="modal-backdrop">
            <div class="modal-content">
                <span id="close-help" class="close-modal">&times;</span>

                <h2 style="margin-bottom: 20px;">仪式指引</h2>

                <div class="tutorial-container">
                    <!-- 步骤 1: 距离 -->
                    <div class="tutorial-step active" data-step="1">
                        <div class="demo-stage">
                            <div class="cam-icon"></div>
                            <div class="face-icon"></div>
                            <div style="position:absolute; bottom:10px; font-size:12px; color:#aaa;">50cm - 80cm</div>
                        </div>
                        <h3>1. 保持合适距离</h3>
                        <p style="color:#ccc; font-size:14px; margin-bottom:10px;">
                            请确保您的上半身出现在摄像头画面中。<br>
                            距离屏幕约一臂距离效果最佳。
                        </p>
                    </div>

                    <!-- 步骤 2: 移动 -->
                    <div class="tutorial-step" data-step="2">
                        <div class="demo-stage">
                            <div class="cursor-target"></div>
                            <div class="cursor-dot"></div>
                            <div class="hand-icon anim-move"></div>
                        </div>
                        <h3>2. 控制光标</h3>
                        <p style="color:#ccc; font-size:14px; margin-bottom:10px;">
                            举起单手，光标会跟随您的掌心移动。<br>
                            移动手掌以浏览不同的卡牌。
                        </p>
                    </div>

                    <!-- 步骤 3: 捏合 -->
                    <div class="tutorial-step" data-step="3">
                        <div class="demo-stage">
                            <div class="pinch-hand">
                                <div class="pinch-palm"></div>
                                <div class="finger-thumb"></div>
                                <div class="finger-index"></div>
                                <div class="pinch-ring"></div>
                            </div>
                        </div>
                        <h3>3. 确认选择</h3>
                        <p style="color:#ccc; font-size:14px; margin-bottom:10px;">
                            将光标对准卡牌，<b>捏合食指与拇指</b>。<br>
                            保持捏合状态约 0.5 秒即可翻开卡牌。
                        </p>
                    </div>

                    <!-- 导航点 -->
                    <div class="step-indicators">
                        <span class="dot active"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>

                    <!-- 控制区域 -->
                    <div class="tutorial-controls">
                        <label class="dont-show-label">
                            <input type="checkbox" id="tut-checkbox">
                            <span>不再自动提示</span>
                        </label>

                        <div class="tut-btns">
                            <button id="tut-skip" class="btn-secondary">跳过</button>
                            <button id="tut-next" class="btn-primary">下一步</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 右下角手势提示 (移动端 CSS 已设为隐藏) -->
        <div id="gesture-hint">
            <p>🤏 捏合：选牌</p>
            <p>🤛 握拳：重置</p>
        </div>

        <!-- 底部版权栏 -->
        <footer id="site-footer">
            <p class="beian-info">
                <span>&copy; 2026 rainbow_yu. All Rights Reserved.</span> |
                <span>沪ICP备2025156088号-1</span> |
                <!--<span>京公网安备 11010000000000号</span> |-->
                <a href="#" id="privacy-link">隐私协议</a> | <a href="#" id="tos-link">服务条款</a>
            </p>
        </footer>

         <!-- 隐私协议模态框 -->
        <div id="privacy-modal" class="modal-backdrop">
            <div class="modal-content large-modal">
                <span id="close-privacy" class="close-modal">&times;</span>
                <h2>隐私政策</h2>
                <div class="legal-text">
                    <h3>1. 数据收集与摄像头使用</h3>
                    <p>ARCANA GESTURA 重视您的隐私。本应用使用 Google MediaPipe 技术进行手势识别。</p>
                    <p><strong>关键声明：所有的摄像头视频流数据仅在您的本地设备（浏览器客户端）进行实时处理。我们绝不会将您的面部、手部图像或任何视频数据上传至云端服务器，也不会进行任何形式的存储或录制。</strong></p>

                    <h3>2. API 密钥存储</h3>
                    <p>如果您选择输入阿里云 Qwen API Key，该密钥将仅存储在您浏览器的本地存储（LocalStorage）中。该密钥仅用于向阿里云发起解牌请求，不会被发送至 ARCANA GESTURA 的服务器，也不会分享给第三方。</p>

                    <h3>3. AI 服务交互</h3>
                    <p>当您进行解牌时，系统会将您抽取的牌面信息（牌名、正逆位）发送至阿里云大模型进行文本生成。此过程遵循阿里云的隐私政策。我们不会发送您的个人身份信息。</p>

                    <h3>4. Cookie 与本地存储</h3>
                    <p>我们仅使用必要的本地存储功能来保存您的 API Key 设置（如您已输入），以便您下次访问时无需重复输入。</p>
                </div>
            </div>
        </div>

        <!-- 服务条款模态框 -->
        <div id="tos-modal" class="modal-backdrop">
            <div class="modal-content large-modal">
                <span id="close-tos" class="close-modal">&times;</span>
                <h2>服务条款</h2>
                <div class="legal-text">
                    <h3>1. 服务性质：仅供娱乐</h3>
                    <p>ARCANA GESTURA 是一个基于 WebGL 和 AI 技术的互动展示项目。<strong>本系统提供的所有塔罗牌解读、命运指引及 AI 生成的文本仅供娱乐、艺术欣赏及心理探索用途。</strong></p>
                    <p>本服务不构成任何形式的心理咨询、法律建议、医疗建议或财务指导。请勿依据本服务的解读做出重大人生决策。</p>

                    <h3>2. 用户行为规范</h3>
                    <p>您同意不利用本服务进行任何非法活动。您输入 API Key 时，必须使用您合法拥有的密钥。严禁试图通过逆向工程、攻击或滥用接口来干扰系统的正常运行。</p>

                    <h3>3. 免责声明</h3>
                    <p>本服务按“现状”提供，不包含任何形式的明示或暗示保证。开发者不对 AI 生成内容的准确性、可靠性或完整性负责。</p>
                </div>
            </div>
        </div>

    </div>

    <!-- 引入核心逻辑脚本 -->
    <script type="module" src="scripts/main.js"></script>
    <script type="module" src="scripts/update.js"></script>
</body>
</html>