<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarot Card Renderer Preview</title>
    <style>
        body {
            margin: 0;
            background-color: #1a1a1a;
            color: #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .sidebar {
            width: 300px;
            background: #222;
            border-right: 1px solid #444;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h2 { margin: 0 0 10px 0; color: #d4af37; font-size: 1.2rem; }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-size: 0.8rem; color: #888; }

        select, input[type="range"] {
            width: 100%;
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 5px;
            border-radius: 4px;
        }

        button {
            background: #d4af37;
            border: none;
            padding: 8px;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #e5c048; }

        .info {
            margin-top: auto;
            font-size: 0.75rem;
            color: #666;
            line-height: 1.4;
        }

        /* å³ä¾§ç”»å¸ƒåŒºåŸŸ */
        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image:
                linear-gradient(45deg, #111 25%, transparent 25%),
                linear-gradient(-45deg, #111 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #111 75%),
                linear-gradient(-45deg, transparent 75%, #111 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            position: relative;
            overflow: auto;
            padding: 20px;
        }

        canvas {
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            background: #000;
            max-height: 90vh;
            border: 1px solid #333;
        }

        #timeDisplay { float: right; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ”® å¡ç‰Œè°ƒè¯•å°</h2>

        <div class="control-group">
            <label>é€‰æ‹©å¡ç‰Œ (Current Card)</label>
            <!-- è¿™é‡Œçš„é€‰é¡¹å°†ç”± JS åŠ¨æ€å¡«å…… -->
            <select id="cardSelector">
                <option disabled>Loading...</option>
            </select>
        </div>

        <div class="control-group">
            <label>æ—¶é—´æµé€Ÿ (Time Speed) <span id="speedDisplay">1.0x</span></label>
            <input type="range" id="speedRange" min="0" max="5" step="0.1" value="1">
        </div>

        <div class="control-group">
            <label>æ‰‹åŠ¨æ—¶é—´è½´ (Scrubber) <span id="timeDisplay">0.00</span></label>
            <input type="range" id="timeScrubber" min="0" max="100" step="0.01" value="0">
        </div>

        <div class="control-group">
            <label>æ§åˆ¶</label>
            <div style="display:flex; gap:10px;">
                <button id="btnPause">æš‚åœ</button>
                <button id="btnReset">é‡ç½®æ—¶é—´</button>
            </div>
        </div>

        <div class="info">
            <p>Canvas Size: 512 x 1024</p>
            <p>é€šè¿‡ cardRegistry åŠ¨æ€åŠ è½½ã€‚</p>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="previewCanvas" width="512" height="1024"></canvas>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. å¯¼å…¥éƒ¨åˆ†
        // ç›´æ¥ä» Registry å¯¼å…¥æ‰€æœ‰æ•°æ®
        // ---------------------------------------------------------

        import { REGISTRY } from './cardRegistry.js';

        // ---------------------------------------------------------
        // 2. æ ¸å¿ƒé€»è¾‘
        // ---------------------------------------------------------

        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // UI å…ƒç´ 
        const selector = document.getElementById('cardSelector');
        const speedRange = document.getElementById('speedRange');
        const speedDisplay = document.getElementById('speedDisplay');
        const timeScrubber = document.getElementById('timeScrubber');
        const timeDisplay = document.getElementById('timeDisplay');
        const btnPause = document.getElementById('btnPause');
        const btnReset = document.getElementById('btnReset');

        // --- åˆå§‹åŒ–ï¼šåŠ¨æ€å¡«å……ä¸‹æ‹‰èœå• ---
        function initDropdown() {
            selector.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

            const keys = Object.keys(REGISTRY);

            if (keys.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Registry is empty";
                selector.add(opt);
                return;
            }

            keys.forEach((key, index) => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                selector.appendChild(opt);
            });

            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            state.cardKey = keys[0];
            selector.value = keys[0];
        }

        // çŠ¶æ€
        let state = {
            cardKey: '', // å°†åœ¨ initDropdown ä¸­è®¾ç½®
            time: 0,
            speed: 1.0,
            paused: false,
            manualScrub: false
        };

        // æ‰§è¡Œåˆå§‹åŒ–
        initDropdown();

        // äº‹ä»¶ç›‘å¬
        selector.addEventListener('change', (e) => {
            state.cardKey = e.target.value;
            // åˆ‡æ¢å¡ç‰Œæ—¶ï¼Œå¦‚æœå¡ç‰Œéœ€è¦é‡ç½®åŠ¨ç”»ï¼Œå¯ä»¥åœ¨è¿™é‡Œé‡ç½®æ—¶é—´
            // state.time = 0;
        });

        speedRange.addEventListener('input', (e) => {
            state.speed = parseFloat(e.target.value);
            speedDisplay.innerText = state.speed.toFixed(1) + 'x';
        });

        timeScrubber.addEventListener('mousedown', () => { state.manualScrub = true; state.paused = true; });
        timeScrubber.addEventListener('mouseup', () => { state.manualScrub = false; if(btnPause.innerText === 'æš‚åœ') state.paused = false; });
        timeScrubber.addEventListener('input', (e) => {
            state.time = parseFloat(e.target.value);
            drawFrame();
        });

        btnPause.addEventListener('click', () => {
            state.paused = !state.paused;
            btnPause.innerText = state.paused ? "æ’­æ”¾" : "æš‚åœ";
        });

        btnReset.addEventListener('click', () => {
            state.time = 0;
            drawFrame();
        });

        // åŠ¨ç”»å¾ªç¯
        let lastTime = performance.now();

        function loop(now) {
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            if (!state.paused && !state.manualScrub) {
                state.time += dt * state.speed;
                // æ›´æ–°è¿›åº¦æ¡ UI
                timeScrubber.value = (state.time % 100).toFixed(2);
            }

            timeDisplay.innerText = state.time.toFixed(2);

            drawFrame();
            requestAnimationFrame(loop);
        }

        function drawFrame() {
            // 1. æ¸…ç©º
            ctx.clearRect(0, 0, width, height);

            // 2. è·å–å½“å‰ç»˜å›¾å‡½æ•°
            const drawFn = REGISTRY[state.cardKey];

            if (drawFn) {
                try {
                    // 3. æ‰§è¡Œç»˜åˆ¶
                    drawFn(ctx, width, height, state.time);
                } catch (err) {
                    console.error("ç»˜åˆ¶é”™è¯¯:", err);
                    ctx.fillStyle = "red";
                    ctx.font = "20px sans-serif";
                    ctx.fillText("Error: " + err.message, 20, 50);

                    // æ‰“å°å †æ ˆä»¥ä¾¿è°ƒè¯•
                    console.log(err.stack);
                }
            } else {
                ctx.fillStyle = "#333";
                ctx.textAlign = "center";
                ctx.fillText("Select a card to preview", width/2, height/2);
            }
        }

        // å¯åŠ¨
        requestAnimationFrame(loop);

    </script>
</body>
</html>