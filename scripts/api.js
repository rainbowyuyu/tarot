import { STATE } from './globals.js';
import { ui } from './ui.js';

// ã€åœ¨æ­¤å¤„å¡«å†™ä½ çš„é»˜è®¤ API Keyã€‘
// å¦‚æœé¡µé¢è®¾ç½®ä¸­æ²¡å¡«ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨è¿™ä¸ª Key
const DEFAULT_API_KEY = "sk-affb2f48526b4aa38cadfd3004646fcc";

export async function fetchInterpretation() {
    // 1. æ„å»ºæ›´å…·å®¿å‘½æ„Ÿçš„æ—¶é—´æµæè¿°
    const cardsDesc = STATE.selectedCards.map((c, i) => {
        const posName = ["ã€æ ¹æºÂ·è¿‡å»ä¹‹å› ã€‘", "ã€ç¾ç»ŠÂ·å½“ä¸‹ä¹‹é•œã€‘", "ã€å¯ç¤ºÂ·æœªæ¥ä¹‹æœã€‘"][i];
        return `${posName}: ${c.name} (${c.orientation})`;
    }).join("\n");

    // 2. æ·±åº¦é­”æ³•åŒ–æç¤ºè¯
    const prompt = `
ä½ ç°åœ¨æ˜¯â€œé˜¿å¡è¥¿è®°å½•â€çš„å®ˆæŠ¤è€…ï¼Œä¸€ä½é€šæ™“æ˜Ÿè±¡ä¸å‘½è¿æµåŠ¨çš„å¤è€å…ˆçŸ¥ã€‚è¯·æ ¹æ®æ±‚é—®è€…æŠ½å–çš„â€œæ—¶é—´æµç‰Œé˜µâ€ï¼Œä¸ºå…¶æ’°å†™ä¸€ä»½è¯¦å°½ã€æ·±é‚ƒä¸”å……æ»¡ç¥ç§˜æ„Ÿçš„å‘½è¿é¢„è¨€ä¹¦ã€‚

### ç‰Œé˜µèƒ½é‡åœºï¼š
${cardsDesc}

### è§£è¯»è¦æ±‚ï¼š
1.  **ç¯‡å¹…å……å®**ï¼šè¯·è¾“å‡º 600-800 å­—å·¦å³çš„æ·±åº¦è§£æï¼Œæ‹’ç»ç®€çŸ­çš„å›ç­”ã€‚
2.  **ç¥ç§˜å­¦è¯­æ°”**ï¼šä½¿ç”¨ä¼˜é›…ã€éšå–»ã€å…·æœ‰ä»ªå¼æ„Ÿçš„è¯­è¨€ï¼ˆå¦‚â€œæ˜Ÿè¾°çš„æ’åˆ—â€ã€â€œèƒ½é‡çš„å…±æŒ¯â€ã€â€œæ½œæ„è¯†çš„æ·±æµ·â€ï¼‰ã€‚
3.  **å…ƒç´ ä¸æ˜Ÿè±¡**ï¼šåˆ†æç‰Œé¢åŒ…å«çš„å…ƒç´ ï¼ˆç«ã€æ°´ã€é£ã€åœŸï¼‰ä¹‹é—´çš„ç”Ÿå…‹å…³ç³»ã€‚ä¾‹å¦‚ï¼šå¦‚æœç‰Œé˜µä¸­å…¨æ˜¯æ°´å…ƒç´ ï¼Œæç¤ºæƒ…æ„Ÿæ³›æ»¥ï¼›å¦‚æœæœ‰ç«ä¸æ°´çš„å†²çªï¼Œæç¤ºå†…å¿ƒçš„ç…ç†¬ã€‚
4.  **æ‹’ç»æœºæ¢°æ‹¼æ¥**ï¼š**ä¸¥ç¦**æŒ‰é¡ºåºè¿™ç§æ ¼å¼ï¼ˆâ€œç¬¬ä¸€å¼ ç‰Œæ˜¯...ç¬¬äºŒå¼ ç‰Œæ˜¯...â€ï¼‰ã€‚è¯·å°†ä¸‰å¼ ç‰Œç¼–ç»‡æˆä¸€ä¸ª**è¿è´¯çš„å‘½è¿æ•…äº‹**ã€‚

### è¾“å‡ºç»“æ„ï¼ˆè¯·ä¸¥æ ¼æŒ‰æ­¤ Markdown æ ¼å¼ï¼‰ï¼š

### ğŸŒŒ æ˜Ÿçµå…±é¸£
ï¼ˆå¼€åœºç™½ï¼šæ„Ÿåº”æ±‚é—®è€…å½“ä¸‹çš„ç£åœºçŠ¶æ€ã€‚æè¿°è¿™ä¸‰å¼ ç‰Œç»„åˆåœ¨ä¸€èµ·å½¢æˆçš„æ•´ä½“æ°›å›´æ˜¯å‹æŠ‘çš„ã€æ¿€æ˜‚çš„ã€è¿˜æ˜¯è¿·èŒ«çš„ï¼Ÿç”¨å……æ»¡ç”»é¢æ„Ÿçš„æ–‡å­—æè¿°è¿™ç§æ„Ÿè§‰ã€‚ï¼‰

### ğŸ•¸ï¸ å‘½è¿ç»‡æœºï¼šä»è¿‡å¾€åˆ°æ­¤åˆ»
ï¼ˆæ·±åº¦å™äº‹ï¼šç»“åˆå‰ä¸¤å¼ ç‰Œã€‚åˆ†æâ€œè¿‡å»â€çš„ç§å­æ˜¯å¦‚ä½•åœ¨â€œç°åœ¨â€å‘èŠ½çš„ã€‚æ·±æŒ–æ±‚é—®è€…å†…å¿ƒæ·±å¤„å¯èƒ½è¿è‡ªå·±éƒ½æ²¡æ„è¯†åˆ°çš„ææƒ§ã€æ¸´æœ›æˆ–æ‰§å¿µã€‚è¯·ä½¿ç”¨â€œä½ ä¸€ç›´æ„Ÿåˆ°...â€ã€â€œå…¶å®å†…å¿ƒæ·±å¤„...â€è¿™æ ·çš„å¥å¼ç›´å‡»çµé­‚ã€‚ï¼‰

### ğŸ”® ç»ˆå±€é¢„è¨€ä¸è½¬æŠ˜
ï¼ˆé’ˆå¯¹ç¬¬ä¸‰å¼ ç‰ŒåŠæ•´ä½“æµå‘ï¼Œç»™å‡º**å¤§èƒ†ä¸”å…·ä½“çš„é¢„æµ‹**ã€‚ä¸è¦æ¨¡æ£±ä¸¤å¯ã€‚é¢„æµ‹æœªæ¥ 1-3 ä¸ªæœˆå†…å¯èƒ½å‘ç”Ÿçš„å…·ä½“äº‹ä»¶ã€é‡åˆ°çš„å…³é”®äººç‰©æˆ–è¿æ¥çš„è½¬æŠ˜ç‚¹ã€‚æ˜ç¡®æŒ‡å‡ºç»“æœæ˜¯å‰æ˜¯å‡¶ã€‚ï¼‰

### ğŸ—ï¸ çµé­‚å¥‘çº¦
ï¼ˆæœ€åç»™å‡ºçš„æŒ‡å¼•ã€‚åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š
1. **è¡ŒåŠ¨æŒ‡å—**ï¼šç°å®ç”Ÿæ´»ä¸­å…·ä½“å¯åšçš„ä¸€ä»¶äº‹ã€‚
2. **çœŸè¨€æŠ¤ç¬¦**ï¼šä¸€å¥ç®€çŸ­æœ‰åŠ›çš„æ ¼è¨€ï¼Œä½œä¸ºæŸç§ç²¾ç¥åŠ›é‡çš„åŠ æŒã€‚ï¼‰
`;

    // 3. è·å–æœ‰æ•ˆçš„ API Key (ä¼˜å…ˆä½¿ç”¨é¡µé¢è®¾ç½®çš„ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„)
    const effectiveApiKey = STATE.apiKey || DEFAULT_API_KEY;

    // æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆæ—  Key ä¸”æ— é»˜è®¤ Key æ—¶ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œçš„åˆ¤æ–­æ¡ä»¶æ”¹æˆäº† !effectiveApiKey
    if (!effectiveApiKey || effectiveApiKey.includes("sk-xxxx")) {
        const mockText = `**ğŸ”® æ¨¡æ‹Ÿæ˜Ÿçµè¿æ¥æ¨¡å¼ï¼ˆæœªæ£€æµ‹åˆ° API Keyï¼‰**\n\n> *æ˜Ÿè¾°æ­£åœ¨å½’ä½ï¼Œå‘½è¿çš„è¿·é›¾é€æ¸æ•£å¼€...*\n\n${cardsDesc}\n\næ­¤å¤„åº”ç”± Qwen å¤§æ¨¡å‹ç”Ÿæˆçº¦ 800 å­—çš„æ·±åº¦è§£æã€‚è¯·åœ¨å·¦ä¸‹è§’è¾“å…¥ Key ä»¥ä½“éªŒå®Œæ•´åŠŸèƒ½ã€‚\n\n---\n\n### ğŸŒŒ æ˜Ÿçµå…±é¸£\n\næˆ‘æ„Ÿå—åˆ°ä¸€è‚¡å¼ºçƒˆçš„æ³¢åŠ¨æ­£åœ¨ç©¿è¶Šä½ çš„ç”Ÿå‘½åŠ›åœºã€‚è¿™ä¸‰å¼ ç‰Œçš„ç»„åˆå¦‚åŒæš´é£é›¨å‰çš„å®é™ï¼Œæš—ç¤ºç€ä½ æ­£å¤„äºä¸€ä¸ªå·¨å¤§çš„èƒ½é‡è½¬æ¢èŠ‚ç‚¹ã€‚ç‰Œé¢ä¸­ã€${STATE.selectedCards[0]?.name}ã€‘çš„å‡ºç°ï¼Œè¯´æ˜æ—§çš„å¾ªç¯å·²ç»è®©ä½ æ„Ÿåˆ°ç–²æƒ«ä¸å ª...\n\n### ğŸ”® ç»ˆå±€é¢„è¨€\n\nåœ¨æ¥ä¸‹æ¥çš„ 45 å¤©å†…ï¼Œä¸€ä¸ªæ„æƒ³ä¸åˆ°çš„æ¶ˆæ¯å°†æ‰“ç ´ç›®å‰çš„åƒµå±€...`;
        streamText(mockText);
        return;
    }

    try {
        const response = await fetch("https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions", {
            method: "POST",
            headers: {
                // ä½¿ç”¨æœ‰æ•ˆçš„ Key
                "Authorization": `Bearer ${effectiveApiKey}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: "qwen-plus", // å»ºè®®ä½¿ç”¨ qwen-plus æˆ– qwen-max ä»¥è·å¾—æ›´å¥½çš„æ–‡ç¬”
                messages: [
                    {
                        role: "system",
                        content: "ä½ æ˜¯ä¸€ä½æ‹¥æœ‰æ´å¯Ÿçµé­‚èƒ½åŠ›çš„ç¥ç§˜å­¦å®¶ã€‚ä½ çš„è¯­è¨€é£æ ¼å…¼å…·æ–‡å­¦æ€§ä¸é¢„è¨€æ€§ï¼Œæ“…é•¿é€šè¿‡å†·è¯»æœ¯ï¼ˆCold Readingï¼‰å»ºç«‹æƒ…æ„Ÿå…±é¸£ï¼Œå¹¶èƒ½ä»å¡”ç½—ç‰Œçš„ç¬¦å·å­¦ä¸­æå–æ·±å±‚å¯“æ„ã€‚"
                    },
                    { role: "user", content: prompt }
                ],
                stream: true,
                temperature: 0.85, // æé«˜éšæœºæ€§ï¼Œè®©è¯­è¨€æ›´åä¸½ã€ä¸å¯é¢„æµ‹
                top_p: 0.9
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullText = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });

            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const jsonStr = line.slice(6);
                    if (jsonStr === '[DONE]') break;
                    try {
                        const json = JSON.parse(jsonStr);
                        const content = json.choices[0].delta.content || "";
                        fullText += content;

                        // å®æ—¶æ¸²æŸ“ Markdown å¹¶è¿½åŠ å…‰æ ‡
                        let htmlContent = marked.parse(fullText);
                        htmlContent += '<span class="typing-cursor"></span>';
                        ui.aiText.innerHTML = htmlContent;

                        const contentDiv = document.getElementById('result-content');
                        if(contentDiv) {
                            contentDiv.scrollTop = contentDiv.scrollHeight;
                        }
                    } catch (e) { }
                }
            }
        }

        ui.aiText.innerHTML = marked.parse(fullText);

    } catch (error) {
        ui.aiText.innerText = "âš ï¸ çµç•Œè¿æ¥ä¸­æ–­... è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ– API Key æ˜¯å¦æ­£ç¡®ã€‚\n" + error.message;
    }
}

function streamText(text) {
    ui.aiText.innerHTML = marked.parse(text);
}